- hosts: web
  become: true
  tasks:
    - name: Ensure app directory exists
      file:
        path: /home/ubuntu/app/blog
        state: directory

    - name: Copy source code to server
      synchronize:
        src: ../  # actions에서 ansible/보다 한단계 상위 (=프로젝트 루트)
        dest: /home/ubuntu/app/blog
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=node_modules"
          - "--exclude=dist"
          - "--exclude=.env"
    
    - name: Copy .env.prod to .env
      shell: cp /home/ubuntu/app/blog/.env.prod /home/ubuntu/app/blog/.env

    - name: Build Docker image
      shell: |
        cd /home/ubuntu/app/blog
        docker build -t blog .

    - name: Stop existing container
      shell: docker rm -f blog || true

    - name: Run new container
      shell: |
        docker run -d \
          --name blog \
          --restart always \
          -p 3000:3000 \
          -v /home/ubuntu/app/blog/.env:/app/.env \
          blog