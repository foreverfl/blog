- hosts: web
  become: true
  tasks:
    - name: Ensure app directory exists
      file:
        path: /home/ubuntu/app/blog
        state: directory

    - name: Copy .env.prod to .env
      shell: cp /home/ubuntu/app/blog/.env.prod /home/ubuntu/app/blog/.env

    - name: Stop existing container
      shell: docker rm -f blog || true

    - name: Remove old blog images (keep latest 2)
      shell: |
        docker images blog -q | tail -n +3 | xargs -r docker rmi -f || true

    - name: Clean up dangling images
      shell: docker image prune -f

    - name: Generate timestamp
      shell: date +%Y%m%d_%H%M%S
      register: timestamp_output

    - name: Set timestamp variable
      set_fact:
        blog_timestamp: "{{ timestamp_output.stdout }}"

    - name: Debug - Show timestamp
      debug:
        msg: "Building image with tag: blog:{{ blog_timestamp }}"

    - name: Build Docker image with timestamp tag
      shell: |
        cd /home/ubuntu/app/blog
        echo "Starting Docker build..."
        docker build --no-cache -t blog:{{ blog_timestamp }} . 2>&1
      register: build_result
      failed_when: build_result.rc != 0

    - name: Debug - Show build output
      debug:
        var: build_result

    - name: Verify image was built successfully
      shell: docker images blog:{{ blog_timestamp }} --quiet
      register: image_check
      failed_when: image_check.stdout == ""

    - name: Debug - Show available images
      shell: docker images blog
      register: available_images

    - name: Debug - Display available images
      debug:
        var: available_images.stdout_lines

    - name: Run new container
      shell: |
        docker run -d \
          --name blog \
          --restart always \
          -p 3000:3000 \
          -v /home/ubuntu/app/blog/.env:/app/.env \
          blog:{{ blog_timestamp }}
      register: container_result

    - name: Debug - Show container run result
      debug:
        var: container_result