name: Process HackerNews

on:
  schedule:
    - cron: "00 16 * * *" # KST (UTC+9) 01:00
  workflow_dispatch:  

jobs:
  run-tasks:
    runs-on: ubuntu-22.04
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ap-northeast-1
      HACKERNEWS_API_KEY: ${{ secrets.HACKERNEWS_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq awscli

      - name: Turn on Redis (Fargate)
        run: |
          aws ecs update-service \
            --cluster mogumogu \
            --service mogumogu-service-dr9p94qm \
            --desired-count 1
          echo "⏳ Waiting for Redis task to start..."
          sleep 30

      - name: Get Redis private IP
        id: get_redis_ip
        run: |
          REDIS_IP=$(aws ecs describe-tasks \
            --cluster mogumogu \
            --tasks $(aws ecs list-tasks --cluster mogumogu \
              --service-name mogumogu-service-dr9p94qm \
              --desired-status RUNNING \
              --query 'taskArns[0]' --output text) \
            --query 'tasks[0].attachments[0].details[?name==`privateIPv4Address`].value' \
            --output text)
          echo "Redis IP is $REDIS_IP"
          echo "REDIS_HOST=$REDIS_IP" >> $GITHUB_ENV
          echo "REDIS_PORT=6379" >> $GITHUB_ENV

      - name: Print Redis env (for debugging)
        run: echo "REDIS_HOST=$REDIS_HOST, REDIS_PORT=$REDIS_PORT"

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Node.js dependencies
        run: npm install

      - name: Install Playwright
        run: npx playwright install --with-deps

      - name: Fetch HackerNews data
        run: ./scripts/fetch-hackernews-prod.sh
 
      - name: Summarize HackerNews content
        run: |
          curl -v -X POST https://mogumogu.dev/api/hackernews/summarize/ \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $HACKERNEWS_API_KEY"

      - name: Translate HackerNews to Korean
        run: |
          curl -v -X POST "https://mogumogu.dev/api/hackernews/translate?lang=ko" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $HACKERNEWS_API_KEY"

      - name: Translate HackerNews to Japanese
        run: |
          curl -v -X POST "https://mogumogu.dev/api/hackernews/translate?lang=ja" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $HACKERNEWS_API_KEY"

      - name: 🎨 Generate HackerNews image
        run: |
          TODAY=$(date -d '9 hours' +'%y%m%d')
          curl -X POST https://mogumogu.dev/api/hackernews/draw/$TODAY/ \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $HACKERNEWS_API_KEY" \
            -d '{"webhookUrl": "http://mogumogu.dev/api/hackernews/webhook/draw"}'

      - name: ✅ Final message
        run: echo "All HackerNews tasks completed successfully!"

      - name: Turn off Redis (Fargate)
        if: always()
        run: |
          aws ecs update-service \
            --cluster mogumogu \
            --service mogumogu-service-dr9p94qm \
            --desired-count 0